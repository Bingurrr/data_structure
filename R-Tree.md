# R-Tree

- B-트리를 다차원으로 확장시킨 완전 균형 트리
- 선 면 도형 등 다차원 공간 데이터 저장 가능

### 노드 형식

MBR -> Minumum bounding rectangle
공간을 포함하는 가장 작은 직사각형을 MBR이라고 한다.
좌표로 따지면 (X_min, Y_min)(X_max, Y_max)이다
(X min, X max, Y min, Y max)로 표현한다

내부 노드의 엔트리 형식
<MBR, node-pointer>
pointer -> main memory

단말 노드 엔트리 형식
<MBR, address>
address -> disk address

R-Tree 중요한 점
분기가 3개이면 child도 3개가 된다.
R-Tree에서는 영역으로 접근하기 때문에 분기 수 만큼 sub트리가 있다.


### 영역 검색
1. 하나의 영역만 겹칠경우
영역 Q1이 주어지고 이 안에 있는 사각형을 찾는다
Q1<a1,a2,a3,a4> -> 이를 이용해서 트리에서 검색을 한다
오버랩 되어 있는것을 확인한다.

겹치는 부분을 계속해서 찾는다.


2. 여러개의 영역에 오버랩 되는 경우
두곳의 포인터 값으로 내려가게 된다.


NOTE : MBR이 겹치는 부분이 클수록, 검색 성능이 떨어짐
겹치는 BBR이 최대한 작게, 노드 삽입이 이루어 져야함

### K-NN질의
질의점으로부터 가장 가까운 k개의 데이터를 검색
Q1이라는 점이 주어진다.

Q1의 위치에서 가까운 영역을 k개를 리턴한다

중앙점 사이에서의 거리를 측정한다.

그 영역과의 최소 거리

x축과 y축방향으로 연장했을 시
만나지 않을떄는 가장 가까운 꼭짐점 과의 거리


내부에 있는것이 외부에 있는것보다 무조건 가깝다

우선순위 큐를 이용하여 구현을 한다.

### R-Tree 삽입

ChooseLeaf 알고리즘 사용
-> 데이터를 삽입할 단말 노드 선택

단말 노드에 데이터 저장
빈공간이 있으면 새로운 엔트리 E저장
빈공간이 없는경우 overflow가 발생 노드를 분할하고 E를 저장
노드의 분할로 추가되는 MBR을 저장할 빈 공간이 부모노드에 없는경우
overflow가 발생 부모 노드도 분할

**MBR 재조정**
데이터가 삽입된 경로를 따라 루트까지 가면서, 새로운 데이터 삽입으로 변화된 MBR들을 조정
새로 분활된 노드 삽입. 내부 노드의 분할이 일어날 수 있음

### ChooseLeaf 알고리즘
MBR의 크기가 가장 작게 증가하는 노드 N의 엔트리 F를 선택
-> 겹치는 MBR의 크기가 작은 확률이 최대인 방법임

MBR을 올라가면서 다 바꿔줘야한다.


### Node Split 알고리즘
분할 된 두 노드 MBR의 합이 최소가 되도록 선택
-> 상위 노드 MBR의 크기를 최소화함으로써, 검색시
불필요한 노드의 탐색을 줄일 수 있음
- (a)를 2개의 노드에 2개씩 분할하는 3가지 방법
MBR의 합이 작은걸로 합친다



### R-Tree 삭제
underflow가 발생한다.
-> 재분배나 합병이 발생하지 않고 통채로 노드를 삭제한다.
-> 부모의 entry도 삭제된다
그리고 다시 삽입을 하게 된다.

 



